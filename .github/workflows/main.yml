name: Swift

on:
  pull_request:
    branches: [ main ]

jobs:
  check-version:
    uses: kokoichi206/twitter-clone-ios/.github/workflows/check-version.yml@5f644c769d031eefeb4c63ba6a99bb267c47fc7f

  build-and-test:
    needs: [ check-version ]
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v2
    - name: Build
      run: swift build -v
    - name: Run tests
      run: swift test -v

    - name: UITests
      run: xcodebuild test -project TwitterClone.xcodeproj/ \
          -scheme TwitterCloneUITests -resultBundlePath TestResults \
          -sdk iphonesimulator -destination "platform=iOS Simulator,name=iPhone 13"
    
    - name: Check dirs
      run: ls

    - name: Archive test artifacts
      uses: actions/upload-artifact@v2
      with:
        name: test-artifacts
        path: |
          ~/Library/Developer/Xcode/DerivedData/*
          ~/Library/Developer/Xcode/DerivedData/*/Logs/Test/*.xcresult
        if: always()

  swift-lint:
    needs: [ check-version ]
    runs-on: macos-11
    steps:
      - uses: actions/checkout@v2
      
      - name: Lint code using SwiftLint
        run: swiftlint lint --reporter github-actions-logging
